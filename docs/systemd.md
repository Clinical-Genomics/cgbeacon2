## Deploying the app as a service using systemd and Podman

This short guide is intended as an example of configuration (please note that it is experimental and as such not to be used in production!) for system admins who would like to deploy the Beacon as a service using Linux systemd unit config files.

### Prerequisites
- Linux OS
- Podman version >= 2.0.4

To run Podman from Windows or MacOS you can either use a [remote client](https://github.com/containers/podman/blob/master/docs/tutorials/mac_win_client.md#podman-remote-clients-for-macos-and-windows) or run Linux inside a [virtual machine](https://github.com/northwestwitch/howtos/blob/master/containers/podman_on_mac.md).

### Creating a common directory for service files
First create a folder in the user's home directory that will contain all systemd unit config files:
```
mkdir -p ~/.config/systemd/user
```

### MongoDB service file
First thing to do is choosing a MongoDB image to use as database. To be consistent with the docker-compose file let√§s use the lightweight MongoDB image(mvertes/alpine-mongo) pulled from Docker Hub:
```
podman pull mvertes/alpine-mongo
```
Assign the image a name, so it will be later used in the systemd service file. In this case the name will be `mongodb`:
```
podman run -d --name mongodb -p 27017:27017 alpine-mongo
```
Create a service file for mongodb with the following command:
```
podman generate systemd --name mongodb
```
The content of this file will look like this:
```
# container-mongodb.service
# autogenerated by Podman 2.2.1
# Tue Feb  2 08:31:05 UTC 2021

[Unit]
Description=Podman container-mongodb.service
Documentation=man:podman-generate-systemd(1)
Wants=network.target
After=network-online.target

[Service]
Environment=PODMAN_SYSTEMD_UNIT=%n
Restart=on-failure
ExecStart=/usr/bin/podman run --name beacon-mongo -d --log-driver=journald -p 27017:27017 docker.io/mvertes/alpine-mongo:latest
ExecStop=/usr/bin/podman stop -t 10 beacon-mongo
ExecStopPost=/usr/bin/podman rm --ignore -f beacon-mongo
KillMode=none
Type=forking

[Install]
WantedBy=multi-user.target default.target
```
Create a service config file under ~/.config/systemd/user:
```
touch ~/.config/systemd/user/container-mongodb.service
```
And copy the generated file content into this service file.

After creating the unit file, to start the container automatically at boot time, type the following:
```
systemctl --user daemon-reload
systemctl --user enable container-mongodb.service
```
Once the service is enabled, it will start at boot time. To start it immediately and check the status of the service, type the following:
```
systemctl --user start container-mongodb.service
systemctl --user status container-mongodb.service
```
To stop the service type the following command:
```
systemctl --user stop container-mongodb.service
```

### Beacon cli service file
Pull the Beacon image from Docker Hub and run it:
```
podman pull clinicalgenomics/cgbeacon2
```

Create the content of the service file for the Beacon command line:
```
# container-beacon-cli.service
# autogenerated by Podman 2.2.1
# Tue Feb  2 09:09:53 UTC 2021

[Unit]
Description=Podman container-beacon-cli.service
Documentation=man:podman-generate-systemd(1)
Requires= container-mongodb.service
Wants=network.target
After=network-online.target

[Service]
Environment=PODMAN_SYSTEMD_UNIT=%n
Environment="SCRIPT_ARGS=%I"
Restart=on-failure
ExecStart=/usr/bin/podman run beacon $SCRIPT_ARGS
ExecStop=/usr/bin/podman stop -t 10 cgbeacon2
ExecStopPost=/usr/bin/podman stop -t 10 cgbeacon2
PIDFile=/run/user/1000/containers/vfs-containers/560ef258978365673c6c1c31b78b5240d13f0ce74242dad3dcc51eb327c4d3ff/userdata/conmon.pid
KillMode=none
Type=forking

[Install]
WantedBy=multi-user.target default.target
```
Create the service file under ~/.config/systemd/user:
```
touch ~/.config/systemd/user/container-beacon-cli.service
```
And write the content above inside it.
We are not interested in running the Beacon command line container at boot, so we'll skip that step.

```
systemctl --user daemon-reload
```

### Beacon web service file
Assuming that the Beacon image is already present (see first step of chapter above), let's create a service config file to start the Beacon web app and keep it running.
Let's add the following unit file to the ~/.config/systemd/user folder:
```
# container-beacon-web.service
# autogenerated by Podman 2.2.1
# Tue Feb  2 09:09:53 UTC 2021

[Unit]
Description=Podman container-beacon-web.service
Documentation=man:podman-generate-systemd(1)
Requires= container-mongodb.service
Wants=network.target
After=network-online.target

[Service]
Environment=PODMAN_SYSTEMD_UNIT=%n
Restart=no # Eventually turn this into on-failure
ExecStart=/usr/bin/podman run --env "MONGODB_HOST=mongodb" -d --log-driver=journald --name beacon-web -p 5000:5000 clinicalgenomics/cgbeacon2 run
ExecStop=/usr/bin/podman stop beacon-web
ExecStopPost=/usr/bin/podman rm --ignore -f beacon-web
TimeoutStartSec=1800s
Type=forking

[Install]
WantedBy=multi-user.target default.target
