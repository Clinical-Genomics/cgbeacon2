## Deploying the app as a service using systemd and Podman

This short guide is intended as an example of configuration (please note that it is experimental and as such not to be used in production!) for system admins who would like to deploy the Beacon as a service using Linux systemd unit config files.

### Prerequisites
- Linux OS
- Podman version >= 2.0.4

To run Podman from Windows or MacOS you can either use a [remote client](https://github.com/containers/podman/blob/master/docs/tutorials/mac_win_client.md#podman-remote-clients-for-macos-and-windows) or run Linux inside a [virtual machine](https://github.com/northwestwitch/howtos/blob/master/containers/podman_on_mac.md).

### Creating a common directory for service files
First create a folder in the user's home directory that will contain all systemd unit config files:
```
mkdir -p ~/.config/systemd/user
```

### MongoDB service file
First thing to do is choosing a MongoDB image to use as database. To be consistent with the docker-compose file let's use the lightweight MongoDB image(mvertes/alpine-mongo) pulled from Docker Hub:
```
podman pull mvertes/alpine-mongo
```
Assign the image a name, so it will be later used in the systemd service file. In this case the name will be `beacon-mongo`:
```
podman run -d --name beacon-mongo -p 27017:27017 alpine-mongo
```
Create a service file for mongodb with the following command:
```
podman generate systemd --name beacon-mongo
```
The content of this file will look like this:
```
# container-beacon-mongo.service
# autogenerated by Podman 2.2.1
# Fri Mar  5 14:22:07 UTC 2021

[Unit]
Description=Podman container-beacon-mongo.service
Documentation=man:podman-generate-systemd(1)
Wants=network.target
After=network-online.target

[Service]
Environment=PODMAN_SYSTEMD_UNIT=%n
Restart=on-failure
ExecStart=/usr/bin/podman start beacon-mongo
ExecStop=/usr/bin/podman stop -t 10 beacon-mongo
ExecStopPost=/usr/bin/podman stop -t 10 beacon-mongo
PIDFile=/run/user/1000/containers/overlay-containers/4c2b7b40494965cd58fa1dc16baee123902a953e70fb9a24eb49f9d6f7b0fd87/userdata/conmon.pid
KillMode=none
Type=forking

[Install]
WantedBy=multi-user.target default.target
```
Add the following line to this file, in the [Unit] section:
```
BindsTo=beacon-pod.service
```

Create a service config file under ~/.config/systemd/user:
```
touch ~/.config/systemd/user/beacon-mongo.service
```
And copy the generated file content into this service file.

After creating the unit file, to start the container automatically at boot time, type the following:
```
systemctl --user daemon-reload
systemctl --user enable beacon-mongo.service
```
Once the service is enabled, it will start at boot time. To start it immediately and check the status of the service, type the following:
```
systemctl --user start beacon-mongo.service
systemctl --user status beacon-mongo.service
```
To stop the service type the following command:
```
systemctl --user stop beacon-mongo.service
```

### Beacon cli service file
```
podman create --name beacon clinicalgenomics/cgbeacon2
```
Create the service file under ~/.config/systemd/user:
```
touch ~/.config/systemd/user/beacon-cli.service
```
Generate the systemd file content:
```
podman generate systemd --name beacon
```
Add the content of the service file to the service file:
```
vi ~/.config/systemd/user/beacon-cli.service
```
Don't forget to include this line under the [Unit] section:
```
Requires= beacon-mongo.service
```
Reload services and enable beacon-cli
```
systemctl --user daemon-reload
systemctl --user enable beacon-cli.service
```


### Beacon web service file
Assuming that the Beacon image is already present (see first step of chapter above), let's create a service config file to start the Beacon web app and keep it running.

Let's add the following unit file to the ~/.config/systemd/user folder:
```
touch ~/.config/systemd/user/beacon-web.service
```
Let's add the following content to the file
```
# beacon-web.service

[Unit]
Description=Podman beacon-web.service
Documentation=man:podman-generate-systemd(1)
Requires= beacon-mongo.service
Wants=network.target
After=network-online.target

[Service]
Environment=PODMAN_SYSTEMD_UNIT=%n
Restart=no # Eventually turn this into on-failure
ExecStart=/usr/bin/podman run --env "MONGODB_HOST=mongodb" -d --log-driver=journald --name beacon-web -p 6000:6000 clinicalgenomics/cgbeacon2 run
ExecStop=/usr/bin/podman stop beacon-web
ExecStopPost=/usr/bin/podman rm --ignore -f beacon-web
TimeoutStartSec=1800s
Type=forking

[Install]
WantedBy=multi-user.target default.target
```
Reload services and enable beacon-cli
```
systemctl --user daemon-reload
systemctl --user enable beacon-web.service
```
Once the service is enabled, it will start at boot time. To start it immediately and check the status of the service, type the following:
```
systemctl --user start beacon-web.service
systemctl --user status beacon-web.service
```

Output from the command above:
```
● beacon-web.service - Podman beacon-web.service
     Loaded: loaded (/home/vagrant/.config/systemd/user/beacon-web.service; enabled; vendor preset: disabled)
     Active: active (running) since Fri 2021-03-05 15:10:59 UTC; 12s ago
       Docs: man:podman-generate-systemd(1)
    Process: 22165 ExecStart=/usr/bin/podman run --env MONGODB_HOST=mongodb -d --log-driver=journald --name beacon-web -p 6000:6000 clinicalgenomics/cgbeacon2 run (code=exited, status=0>
      Tasks: 20 (limit: 1129)
     Memory: 127.4M
        CPU: 857ms
     CGroup: /user.slice/user-1000.slice/user@1000.service/beacon-web.service
             ├─22186 /usr/bin/slirp4netns --disable-host-loopback --mtu 65520 --enable-sandbox --enable-seccomp -c -e 3 -r 4 --netns-type=path /run/user/1000/netns/cni-ca198e4c-16ed-635>
             ├─22188 containers-rootlessport
             ├─22195 /usr/bin/fuse-overlayfs -o lowerdir=/home/vagrant/.local/share/containers/storage/overlay/l/LC4437NCV6N2LAK2TH5GB4CHUO:/home/vagrant/.local/share/containers/storage>
             ├─22196 containers-rootlessport-child
             └─22208 /usr/bin/conmon --api-version 1 -c 1df396a7135b15d460bb3d7d36661447f9dd33fe4326d01b2f3f9b0c3cea0eb9 -u 1df396a7135b15d460bb3d7d36661447f9dd33fe4326d01b2f3f9b0c3cea0>

Mar 05 15:10:59 localhost.localdomain podman[22173]: 2021-03-05 15:10:59.397135996 +0000 UTC m=+0.449354072 container start 1df396a7135b15d460bb3d7d36661447f9dd33fe4326d01b2f3f9b0c3cea0>
Mar 05 15:10:59 localhost.localdomain podman[22173]: 1df396a7135b15d460bb3d7d36661447f9dd33fe4326d01b2f3f9b0c3cea0eb9
Mar 05 15:10:59 localhost.localdomain systemd[630]: Started Podman beacon-web.service.
Mar 05 15:11:02 localhost.localdomain conmon[22208]:  * Environment: production
Mar 05 15:11:02 localhost.localdomain conmon[22208]:    WARNING: This is a development server. Do not use it in a production deployment.
Mar 05 15:11:02 localhost.localdomain conmon[22208]:    Use a production WSGI server instead.
Mar 05 15:11:02 localhost.localdomain conmon[22208]:  * Debug mode: off
Mar 05 15:11:02 localhost.localdomain conmon[22208]: INFO:cgbeacon2.server:Environment variable settings not found, configuring from instance file.
Mar 05 15:11:02 localhost.localdomain conmon[22208]: INFO:cgbeacon2.server:database connection info:Database(MongoClient(host=['mongodb:27017'], document_class=dict, tz_aware=False, con>
Mar 05 15:11:02 localhost.localdomain conmon[22208]: INFO:werkzeug: * Running on http://127.0.0.1:6000/ (Press CTRL+C to quit)
```

To stop the service type the following command:
```
systemctl --user stop beacon-web.service
```
